package model

import (
	"toWers/backend/common"

	"github.com/burugo/thing"
	redisCache "github.com/burugo/thing/drivers/cache/redis"
	"github.com/burugo/thing/drivers/db/sqlite"
)

// Global variables for compatibility with old code, can be gradually removed
// var DB *gorm.DB

func init() {}

func createRootAccountIfNeed() error {
	// Check if any users exist, if not create root user
	userThing, err := thing.Use[*User]()
	if err != nil {
		return err
	}
	users, err := userThing.Query(thing.QueryParams{}).Fetch(0, 1)
	if err != nil {
		return err
	}
	if len(users) == 0 {
		common.SysLog("no user exists, create a root user for you: username is root, password is 123456")
		rootUser := &User{
			Username:    "root",
			Password:    "123456", // Use plain text password, let Insert method handle hashing
			Role:        common.RoleRootUser,
			Status:      common.UserStatusEnabled,
			DisplayName: "Root User",
			Email:       "root@localhost",
			GitHubId:    "",
			WeChatId:    "",
			// Token will be auto-generated by Insert method
		}
		err = rootUser.Insert()
		if err != nil {
			return err
		}
	}
	return nil
}

func InitDB() (err error) {
	dbAdapter, err := sqlite.NewSQLiteAdapter(common.SQLitePath)
	if err != nil {
		common.FatalLog(err)
		return err
	}
	var cacheClient thing.CacheClient = nil
	if common.RedisEnabled && common.RDB != nil {
		cacheClient, err = redisCache.NewClient(common.RDB, nil)
		if err != nil {
			return err
		}
	}
	thing.Configure(dbAdapter, cacheClient)

	// 1. AutoMigrate all models first
	thing.AllowDropColumn = true
	err = thing.AutoMigrate(&User{}, &Option{}, &MCPService{}, &UserConfig{}, &ConfigService{}, &ProxyRequestStat{})
	if err != nil {
		return err
	}

	// 2. Initialize all ORM instances
	if err := UserInit(); err != nil {
		return err
	}
	if err := OptionInit(); err != nil {
		return err
	}
	if err := InitOptionMap(); err != nil {
		return err
	}
	if err := MCPServiceInit(); err != nil {
		return err
	}
	if err := ConfigServiceInit(); err != nil {
		return err
	}
	if err := UserConfigInit(); err != nil {
		return err
	}

	// 3. Perform data-dependent operations like creating a root account
	return createRootAccountIfNeed()
}

func CloseDB() error {
	// Thing ORM doesn't need explicit DB close, can be added later if needed
	return nil
}
